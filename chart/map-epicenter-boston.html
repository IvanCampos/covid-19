<!DOCTYPE html>
<html style="height: 100%">
<head>
	<meta charset="utf-8">
</head>
<body style="height: 100%; margin: 0">
<div id="container" style="height: 100%"></div>
<script type="text/javascript" src="../dist/vendors/echarts/echarts.min.js"></script>
<script type="text/javascript" src="../dist/vendors/echarts-gl/echarts-gl.min.js"></script>
<script type="text/javascript" src="../dist/vendors/echarts-stat/ecStat.min.js"></script>
<script type="text/javascript" src="../dist/vendors/echarts/extension/dataTool.min.js"></script>
<script type="text/javascript" src="../dist/vendors/echarts/map/js/china.js"></script>
<script type="text/javascript" src="../dist/vendors/echarts/map/js/world.js"></script>
<script type="text/javascript" src="../dist/vendors/echarts/extension/bmap.min.js"></script>
<script type="text/javascript" src="../dist/vendors/simplex.js"></script>
<script type="text/javascript" src="../dist/vendors/jquery/jquery-3.1.1.min.js"></script>
<script type="text/javascript">
    var dom = document.getElementById("container");
    var myChart = echarts.init(dom);
    var option = null;

	var data = [];
	var geoCoordMap = {};

	$.get('https://covid-19-api-ja2mrq0w1.now.sh/api/countries/USA/confirmed', function (api) {

		var i;
		var confirmed;
		var deaths;
		var county;
		var lat;
		var long;

		/*var topN = api.sort(function (a, b) {
			return a.confirmed < b.confirmed ? 1 : -1;
		}).slice(0, 100);*/
		var topN = api;

		for (i = 0; i < topN.length; i++) {
			if (topN[i].provinceState == "Massachusetts") {
				confirmed = topN[i].confirmed;
				deaths = topN[i].deaths;
				county = topN[i].admin2;
				lat = topN[i].lat;
				long = topN[i].long;
				data.push({name: county, value: confirmed});
				var coordinates = [long, lat];
				geoCoordMap[county] = coordinates;
			}
		}

		var uploadedDataURL = "../asset/get/s/geojson-boston-zip-codes.json";
		myChart.showLoading();
		$.getJSON(uploadedDataURL, function (geoJson) {
			echarts.registerMap('MA', geoJson);
			myChart.hideLoading();

			var convertData = function (data) {
				var res = [];
				for (var i = 0; i < data.length; i++) {
					var geoCoord = geoCoordMap[data[i].name];
					if (geoCoord) {
						res.push({
							name: data[i].name,
							value: geoCoord.concat(data[i].value)
						});
					}
				}
				return res;
			};

			option = {
				backgroundColor: getColorFromQueryParam(),
				title: {
					text: 'COVID-19 Boston',
					subtext: '',
					x: 'center',
					textStyle: {
						color: '#ccc'
					},
					show: false
				},
				tooltip: {
					trigger: 'item',
					formatter: function (params) {
						if (typeof (params.value)[2] == "undefined") {
							return params.name + ' : ' + params.value;
						} else {
							return params.name + ' : ' + params.value[2];
						}
					}
				},
				visualMap: {
					show: false,
					min: 0,
					max: 400,
					left: 'left',
					top: 'bottom',
					calculable: true,
					seriesIndex: [1],
					inRange: {
						color: ['#0000FF', '#FFFFFF', '#FFFFFF']
					}
				},
				geo: {
					show: true,
					top: 175,
					right: 10,
					zoom: 1.75,
					map: 'MA',
					label: {
						normal: {
							show: false
						},
						emphasis: {
							show: false,
						}
					},
					roam: true,
					itemStyle: {
						normal: {
							areaColor: 'transparent',
							borderColor: '#FF0000',
							borderWidth: 3,
							shadowColor: 'rgba(255, 0, 0, 0.5)',
							shadowBlur: 60
						},
						emphasis: {
							areaColor: '#2B91B7',
						}
					}
				},
				series: [
					{
						type: 'map',
						map: 'MA',
						geoIndex: 0,
						showLegendSymbol: false,
						label: {
							normal: {
								show: false
							},
							emphasis: {
								show: false,
								textStyle: {
									color: '#fff'
								}
							}
						},
						roam: true,
						itemStyle: {
							normal: {
								areaColor: '#FFFFFF',
								borderColor: '#FFFFFF',
							},
							emphasis: {
								areaColor: '#FFFFFF'
							}
						},
						animation: true,
						data: data
					},
					{
						name: 'MA',
						type: 'effectScatter',
						coordinateSystem: 'geo',
						data: convertData(data.sort(function (a, b) {
							return b.value - a.value;
						})),
						symbolSize: function (val) {
							return val[2] / 80;
						},
						showEffectOn: 'render',
						rippleEffect: {
							brushType: 'stroke'
						},
						hoverAnimation: true,
						label: {
							normal: {
								formatter: '{b}',
								position: 'right',
								show: true
							}
						},
						itemStyle: {
							normal: {
								color: '#FFFFFF',
								shadowBlur: 10,
								shadowColor: '#FFFFFF'
							}
						},
						zlevel: 1
					},

				]
			};
			myChart.setOption(option);
		});
		;
		if (option && typeof option === "object") {
			myChart.setOption(option, true);
		}

	});

    $(window).on('resize', function () {
        if (myChart != null && myChart != undefined) {
            myChart.resize();
        }
    });

    function getColorFromQueryParam() {
        var color = "#000000";
        if (!window.location.search) return color;

        let params = new URLSearchParams(window.location.search);

        for (let p of params) {
            color = "#" + p[1];
        }

        return color;
    }
</script>
</body>
</html>